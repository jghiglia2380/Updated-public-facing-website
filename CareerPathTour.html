import { useState, useEffect } from "react";

function StepProgress({ currentStep, totalSteps, stepTitles }) {
  return (
    <div className="flex justify-between mb-6">
      {stepTitles.map((title, index) => (
        <div key={index} className="flex-1 text-center">
          <div
            className={`h-2 mb-1 rounded ${
              index <= currentStep ? "bg-indigo-600" : "bg-gray-200"
            }`}
          ></div>
          <span
            className={`text-xs ${
              index === currentStep ? "text-indigo-700 font-bold" : "text-gray-500"
            }`}
          >
            {title}
          </span>
        </div>
      ))}
    </div>
  );
}

function GoalSelector({ categories, selectedGoals, onSelect, activeKey }) {
  return (
    <div className="space-y-6">
      {Object.entries(categories).map(([key, cat]) => (
        <div
          key={key}
          className={`border-2 rounded-xl transition-all duration-500 p-4 shadow-sm ${
            key === activeKey
              ? "border-blue-500 bg-blue-50 ring-2 ring-blue-200"
              : "border-gray-200"
          }`}
        >
          <label className="block text-sm font-semibold text-gray-700 mb-2">
            {cat.label}
          </label>
          <p className="text-xs text-gray-500 mb-2">Make a selection from the dropdown below</p>
          <select
            className="w-full border border-gray-300 rounded-md p-2"
            value={selectedGoals[key] || ""}
            onChange={(e) => onSelect(key, e.target.value)}
          >
            <option value="">Select a goal</option>
            {cat.options.map((opt) => (
              <option key={opt} value={opt}>
                {opt}
              </option>
            ))}
          </select>
        </div>
      ))}
    </div>
  );
}

function CompletionSummary({ goals, timeFrames, categories, onRestart }) {
  return (
    <div className="bg-white p-6 rounded shadow max-w-4xl mx-auto mt-12">
      <h2 className="text-2xl font-bold text-gray-800 mb-6">Career Path Summary</h2>
      <div className="space-y-6">
        {timeFrames.map((frame) => (
          <div key={frame.id}>
            <h3 className="text-lg font-semibold text-indigo-700 mb-2">{frame.label}</h3>
            <ul className="pl-4 list-disc text-gray-700">
              {categories.map(({ id, label }) => (
                <li key={id}>
                  <span className="font-medium">{label}:</span> {goals?.[frame.id]?.[id] || "Not selected"}
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>
      <div className="mt-8 text-center">
        <button
          onClick={onRestart}
          className="bg-indigo-600 text-white py-2 px-6 rounded shadow hover:bg-indigo-700 transition"
        >
          Restart Tour
        </button>
      </div>
    </div>
  );
}

export default function CareerPathTourPreview() {
  const [currentStep, setCurrentStep] = useState(0);
  const [selections, setSelections] = useState({});
  const [isCompleted, setIsCompleted] = useState(false);
  const [guidedStep, setGuidedStep] = useState(0);
  const [caption, setCaption] = useState("");

  const mockSkillBuilder = {
    sections: [
      {
        id: "short_term",
        title: "Short-Term Goals",
        categories: {
          education: { label: "Education Goals", options: ["Take AP/College prep courses", "Research college programs", "Apply for summer programs", "Complete college applications", "Start SAT/ACT prep"] },
          work: { label: "Work Experience Goals", options: ["Get part-time job in field of interest", "Summer internship", "Job shadowing experience", "Volunteer work", "Start a small project"] },
          networking: { label: "Networking Goals", options: ["Join school clubs", "Connect with teachers/counselors", "Create LinkedIn profile", "Attend school career fair", "Join student organizations"] },
          skills: { label: "Skill Development Goals", options: ["Learn basic computer skills", "Develop study habits", "Practice time management", "Build communication skills", "Start learning industry tools"] },
          other: { label: "Other Goals", options: ["Create initial resume", "Start career research", "Build basic portfolio", "Set SMART goals", "Explore interests through hobbies"] },
        },
      },
      {
        id: "mid_term",
        title: "Mid-Term Goals",
        categories: {
          education: { label: "Education Goals", options: ["Complete associate's degree", "Transfer to 4-year college", "Earn specialized certifications", "Study abroad opportunity", "Complete major prerequisites"] },
          work: { label: "Work Experience Goals", options: ["Secure paid internship", "Take on leadership role", "Work on collaborative projects", "Start freelancing", "Research assistant position"] },
          networking: { label: "Networking Goals", options: ["Join professional associations", "Attend industry conferences", "Build mentor relationships", "Participate in industry events", "Lead student organizations"] },
          skills: { label: "Skill Development Goals", options: ["Master advanced software", "Develop project management skills", "Learn additional languages", "Build public speaking skills", "Advance technical expertise"] },
          other: { label: "Other Goals", options: ["Create professional website", "Publish articles/blog posts", "Build investment portfolio", "Develop personal brand", "Start side business"] },
        },
      },
      {
        id: "long_term",
        title: "Long-Term Goals",
        categories: {
          education: { label: "Education Goals", options: ["Complete bachelor's degree", "Pursue master's degree", "Earn professional license", "Complete doctoral program", "Obtain executive education"] },
          work: { label: "Work Experience Goals", options: ["Secure management position", "Start own company", "Lead department/division", "Become industry expert", "International work experience"] },
          networking: { label: "Networking Goals", options: ["Become industry speaker", "Mentor others", "Lead professional organization", "Build global network", "Create industry partnerships"] },
          skills: { label: "Skill Development Goals", options: ["Develop executive leadership", "Master strategic planning", "Build team management expertise", "Advanced industry certification", "Innovation/Research skills"] },
          other: { label: "Other Goals", options: ["Write book/publication", "Patent innovation", "Create industry impact", "Build lasting legacy", "Philanthropic initiatives"] },
        },
      },
    ],
  };

  const timeFrames = mockSkillBuilder.sections.map((section) => ({
    id: section.id,
    label: section.title,
  }));

  const autoSelections = [
    "Attend a trade school",
    "Get a part-time internship",
    "Join a local networking group", "Attend a virtual networking event", "Join a student organization",
    "Learn Excel or Canva", "Take a public speaking workshop", "Study project management",
    "Attend a virtual career fair", "Tour a college campus", "Talk to a guidance counselor",
  ];

  // Removed auto-advancing useEffect â€” replaced with manual control

  const handleSelection = (sectionId, category, value) => {
    setSelections((prev) => ({
      ...prev,
      [sectionId]: {
        ...prev[sectionId],
        [category]: value,
      },
    }));
  };

  const handleRestart = () => {
    setCurrentStep(0);
    setIsCompleted(false);
    setSelections({});
    setGuidedStep(0);
  };

  if (isCompleted) {
    return (
      <CompletionSummary
        goals={selections}
        timeFrames={timeFrames}
        categories={Object.entries(mockSkillBuilder.sections[0].categories).map(
          ([id, cat]) => ({ id, label: cat.label })
        )}
        onRestart={handleRestart}
      />
    );
  }

  const steps = mockSkillBuilder.sections;
  const currentSection = mockSkillBuilder.sections[currentStep];
  const stepTitles = steps.map((s) => s.title);
  const activeCategoryKey = Object.keys(currentSection.categories)[guidedStep];

  return (
    <div className="bg-white rounded-lg shadow-lg p-8">
      <div className="border-4 border-blue-600 rounded-xl p-6 mb-8 bg-blue-50 shadow">
  <h3 className="text-2xl font-bold text-gray-900 mb-2">
    Guided Career Path Planner Tour
  </h3>
  <p className="text-gray-700 mb-4">
    This interactive experience walks users through the steps students take to define and organize their short-term, mid-term, and long-term career goals.
  </p>
  <div className="flex justify-between text-sm text-indigo-700 font-semibold border-t border-indigo-200 pt-2">
    <span>Short-Term</span>
    <span>Mid-Term</span>
    <span>Long-Term</span>
  </div>
</div>

      <StepProgress currentStep={currentStep} totalSteps={steps.length} stepTitles={stepTitles} />

      <div className="border-4 border-blue-600 rounded-xl p-6 mb-8 bg-blue-50 shadow">
        <h4 className="text-xl font-semibold text-blue-900 mb-2">{currentSection.title}</h4>
        <p className="text-sm text-blue-700 italic mb-4">{caption}</p>
        <GoalSelector
          categories={currentSection.categories}
          selectedGoals={selections[currentSection.id] || {}}
          onSelect={(category, value) => {
            handleSelection(currentSection.id, category, value);
            const categoryKeys = Object.keys(currentSection.categories);
            const isLastCategory = guidedStep >= categoryKeys.length - 1;

            if (!isLastCategory) {
              setGuidedStep((prev) => prev + 1);
            } else if (currentStep < mockSkillBuilder.sections.length - 1) {
              setCurrentStep((prev) => prev + 1);
              setGuidedStep(0);
            } else {
              setIsCompleted(true);
            }
          }}
          activeKey={activeCategoryKey}
        />
      </div>

      {/* Next button removed since selection now triggers step advancement */}
    </div>
  );
}
